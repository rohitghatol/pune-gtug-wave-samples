<Module>
	<ModulePrefs title="Polling" height="250">
		<Require feature="rpc" />
		<Require feature="dynamic-height" />
	</ModulePrefs>
	<Content type="html">
  <![CDATA[
  <script type="text/javascript" 
      src="http://www.crockford.com/javascript/jsmin.html"/>
  <script type="text/javascript"
      src="http://wave-api.appspot.com/public/wave.js"></script>
  <script type="text/javascript">
    var DEBUG=true;
	var TITLE="title";
	
    function renderInfo(){
  
       try{
         if (!wave.getState()) {
           return;
         }
         setup();
         var state=wave.getState();
         if(!state.get(TITLE)) {
           text(TITLE,"Not set yet");
         }
         else {
           text(TITLE,state.get(TITLE));
         } 
   
       }catch(e){
       	   alert(e);
       }
       gadgets.window.adjustHeight();
    }
    
    
    function setPollTitle(id){
      var title = value(id);
      if(title==null){
        alert("Please enter a Title for the polls?");
      }
      else{
	      var state = wave.getState();
	      var delta = {};
	      delta[TITLE]=title;
	      wave.getState().submitDelta(delta);
	  }
      gadgets.window.adjustHeight();
      
    }
    function addOption(id){
      var option = value(id);
      if(option==null){
        alert("Please enter an Option for the polls?");
      }
      else{
	      var state = wave.getState();
	      log(state.toString());
	      var data = {"count":1,"participants":[wave.getViewer().getId()]};
	      var delta = { };
	      alert(JSON.stringfy(data));
	      delta[option] = JSON.stringfy(data);
	      
	      wave.getState().submitDelta(delta);
	      wave.getState().submitDelta({"dummy1":"111"});
	  }
      gadgets.window.adjustHeight();
    }

    function log(text){
       if(DEBUG && document.getElementById("log")!=null)
       document.getElementById("log").innerHTML=document.getElementById("log").innerHTML+"<br>"+text;
    }
    function show(id){
      if(document.getElementById(id)!=null)
      document.getElementById(id).style.display="block";
    }
    function hide(id){
      if(document.getElementById(id)!=null)
      document.getElementById(id).style.display="none";
    }
    function value(id){
      if(document.getElementById(id)!=null)
        return document.getElementById(id).value;
      else
        null;
    }
    function text(id,text){
      if(document.getElementById(id)!=null)
        return document.getElementById(id).innerHTML=text;
      else
        null;
    }
    
    function setup(){
	  hide("owner");      
      if(wave.getViewer().getId()==wave.getHost().getId()){
         show("owner");
      }
    }

    /** 
     * Called when Gadget is loaded.
     * Registers function renderInfo which will be called
     * when ever a state is changed or a participant added
     */
    function init() {
      log("started in init");
      if (wave && wave.isInWaveContainer()) {
        wave.setStateCallback(renderInfo);
        wave.setParticipantCallback(renderInfo);
      }
    }

    gadgets.util.registerOnLoadHandler(init);
    
    
    
  </script>
  <div id="log" style="border:1px dotted red">
  </div>
  <div id="participant">
     <h1 id="title"></h1>
  </div>
  
  <div id="owner" style="display:none">
     <table>
       <tr>
         <td>Enter Polling Title :</td>
         <td><input id="titleInput" type="text" value=""></input></td>
         <td><button id="titleSubmit" name="Set" value="Set" onClick="setPollTitle('titleInput')">Set</button></td>
       </tr>
      </table>
  </div>
  <div>
     <table>
       <tr>
         <td>Add Option:</td>
         <td><input id="addOptionInput" type="text" value=""></input></td>
         <td><button id="addOptionSubmit" name="addOption" value="addOption" onClick="addOption('addOptionInput')">Set</button></td>
       </tr>
      </table>
  </div>
  <div>
    <h2>Poll Results</h2>
    <table>
      
    </table>
  </div>
]]>
	</Content>
</Module>
