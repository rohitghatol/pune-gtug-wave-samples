<Module>
	<ModulePrefs title="Polling" height="250">
		<Require feature="rpc" />
		<Require feature="dynamic-height" />
	</ModulePrefs>
	<Content type="html">
  <![CDATA[
  <script type="text/javascript" 
      src="http://pune-gtug-wave-samples.googlecode.com/svn/trunk/wave-polling-gadget/json2.js"></script>
  <script type="text/javascript"
      src="http://wave-api.appspot.com/public/wave.js"></script>
  <script type="text/javascript">
  // adding it as a prototype object enables it to be used from any array
	Array.prototype.removeItems = function(itemsToRemove) {
	
	    if (!/Array/.test(itemsToRemove.constructor)) {
	        itemsToRemove = [ itemsToRemove ];
	    }
	
	    var j;
	    for (var i = 0; i < itemsToRemove.length; i++) {
	        j = 0;
	        while (j < this.length) {
	            if (this[j] == itemsToRemove[i]) {
	                this.splice(j, 1);
	            } else {
	                j++;
	            }
	        }
	    }
	}
  </script>
  <script type="text/javascript">
    var DEBUG=true;
	var TITLE="title";
	
    function renderInfo(){
  
       try{
         if (!wave.getState()) {
           return;
         }
         setup();
         renderTitle();
         renderPollResult();
   
       }catch(e){
       	   for(var i in e){
       	     alert(i+"="+e[i]);
       	   }
       }
       gadgets.window.adjustHeight();
       
    }
    
    function renderTitle(){
         var state=wave.getState();
         if(!state.get(TITLE)) {
           text(TITLE,"Not set yet");
         }
         else {
           text(TITLE,state.get(TITLE));
         } 
    }
    function renderPollResult(){
      log("inside renderPollResult");
      var state = wave.getState();
      var keys = state.getKeys();
      var pollTable = elem("pollResults");
      var contents="";
      for(var index=0;index<keys.length;index++){
          var key = keys[index];
          if(getValidOptionValue(key)!=null){
              var obj=getValidOptionValue(key);
	          var button = "";
	          if( obj.participants.indexOf( wave.getViewer().getId() )>0 ){
	            button="<button id='"+key+"' onClick='removeVote(\""+key+"\")'>-</button>";
	            
	          }
	          else{
	            button="<button id='"+key+"' onClick='addVote(\""+key+"\")'>+</button>";
	            
	          }
	          contents=contents+"<tr><td>"+key+"</td><td> Polls="+obj.count+"</td><td>"+button+"</td></tr>";
          }
      }
      pollTable.innerHTML=contents;
    }  
    
    function getValidOptionValue(key){
      var state = wave.getState();
      var value = state.get(key);
      
      if(value!=null){
      
    	var validObject=true;
        var obj =null;
        try{
	      obj = JSON.parse(value);
	      if(obj.count ==null){
	        validObject=false;
	     
	      }
	    }
	    catch(e){
	      validObject=false;
	     
	    }
	    if(validObject){
	      return obj;
	    }
	    else{
	      return null;
	    }
	  }
	  else{
	    return null;
	  }
    }
    function addVote(option){
      
      var optionValue = getValidOptionValue(option);
      if(optionValue!=null){
         optionValue.count++;
         optionValue.participants.push(viewer.getViewer().getId());
         var state = wave.getState();
	     var delta = { };
	     log(JSON.stringify(optionValue));
	     delta[option] = JSON.stringify(optionValue);
         wave.getState().submitDelta(delta);
      }
      gadgets.window.adjustHeight();
    
    }
    
    function removeVote(option){
      var optionValue = getValidOptionValue(option);
      if(optionValue!=null){
         optionValue.count--;
         optionValue.participants.removeItems(viewer.getViewer().getId());
         var state = wave.getState();
	     var delta = { };
	     delta[option] = JSON.stringify(optionValue);
	     log(JSON.stringify(optionValue));
         wave.getState().submitDelta(delta);
      }
      gadgets.window.adjustHeight();
    
    }
      
    function setPollTitle(id){
      var title = value(id);
      if(title==null){
        alert("Please enter a Title for the polls?");
      }
      else{
	      var state = wave.getState();
	      var delta = {};
	      delta[TITLE]=title;
	      wave.getState().submitDelta(delta);
	  }
      gadgets.window.adjustHeight();
      
    }
    function addOption(id){
      var option = value(id);
      if(option==null){
        alert("Please enter an Option for the polls?");
      }
      else{
	      var state = wave.getState();
	      var data = {"count":0,"participants":[]};
	      var delta = { };
	      delta[option] = JSON.stringify(data);
	      wave.getState().submitDelta(delta);
	  }
      gadgets.window.adjustHeight();
    }

    function log(text){
       if(DEBUG && document.getElementById("log")!=null)
       document.getElementById("log").innerHTML=document.getElementById("log").innerHTML+"<br>"+text;
    }
    
    function show(id){
      if(document.getElementById(id)!=null)
      document.getElementById(id).style.display="block";
    }
    function hide(id){
      if(document.getElementById(id)!=null)
      document.getElementById(id).style.display="none";
    }
    function value(id){
      if(document.getElementById(id)!=null)
        return document.getElementById(id).value;
      else
        null;
    }
    function elem(id){
      if(document.getElementById(id)!=null)
        return document.getElementById(id);
      else
        null;
    }
    function text(id,text){
      if(document.getElementById(id)!=null)
        return document.getElementById(id).innerHTML=text;
      else
        null;
    }
    
    function setup(){
	  hide("owner");      
      if(wave.getViewer().getId()==wave.getHost().getId()){
         show("owner");
      }
    }

    /** 
     * Called when Gadget is loaded.
     * Registers function renderInfo which will be called
     * when ever a state is changed or a participant added
     */
    function init() {
      if (wave && wave.isInWaveContainer()) {
        wave.setStateCallback(renderInfo);
        wave.setParticipantCallback(renderInfo);
      }
    }

    gadgets.util.registerOnLoadHandler(init);
    
    
    
  </script>
  <div id="log" style="border:1px dotted red">
  </div>
  <div id="participant">
     <h1 id="title"></h1>
  </div>
  
  <div id="owner" style="display:none">
     <table>
       <tr>
         <td>Enter Polling Title :</td>
         <td><input id="titleInput" type="text" value=""></input></td>
         <td><button id="titleSubmit" name="Set" value="Set" onClick="setPollTitle('titleInput')">Set</button></td>
       </tr>
      </table>
  </div>
  <div>
     <table>
       <tr>
         <td>Add Option:</td>
         <td><input id="addOptionInput" type="text" value=""></input></td>
         <td><button id="addOptionSubmit" name="addOption" value="addOption" onClick="addOption('addOptionInput')">Set</button></td>
       </tr>
      </table>
  </div>
  <div>
    <h2>Poll Results</h2>
    <table id="pollResults" width="100%">
      
    </table>
  </div>
]]>
	</Content>
</Module>
